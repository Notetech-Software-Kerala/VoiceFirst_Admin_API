name: Deploy VoiceFirst_Admin API

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows]
    env:
      APP_POOL_NAME: "VoiceFirst_Admin_Web_API"
      WEBSITE_NAME: "VoiceFirst_Admin_Web_API"
      DEPLOY_PATH: "D:\\VoiceFirst_Admin_ApiPublish"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build VoiceFirst_Admin.sln --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: Clean publish directory
        shell: powershell
        run: |
          Write-Host "Cleaning ./publish directory"
          Remove-Item -Path ./publish -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Clean complete"

      - name: Publish
        run: dotnet publish VoiceFirst_Admin.API\VoiceFirst_Admin.API.csproj --configuration Release --output ./publish

      - name: Create/Configure IIS Application Pool
        shell: powershell
        run: |
          $appPoolName = $env:APP_POOL_NAME
          $websiteName = $env:WEBSITE_NAME
          $sitePath = $env:DEPLOY_PATH
          
          # Check if app pool exists
          $appPoolExists = & "C:\Windows\System32\inetsrv\appcmd.exe" list apppool /name:$appPoolName 2>$null
          if (-not $appPoolExists) {
            Write-Host "Creating application pool: $appPoolName"
            & "C:\Windows\System32\inetsrv\appcmd.exe" add apppool /name:$appPoolName /managedRuntimeVersion:"" /managedPipelineMode:Integrated
            Write-Host "Application pool created"
          } else {
            Write-Host "Application pool already exists"
          }
          
          # Check if website exists
          $siteExists = & "C:\Windows\System32\inetsrv\appcmd.exe" list site /name:$websiteName 2>$null
          if (-not $siteExists) {
            Write-Host "Creating website: $websiteName"
            New-Item -ItemType Directory -Path $sitePath -Force | Out-Null
            & "C:\Windows\System32\inetsrv\appcmd.exe" add site /name:$websiteName /physicalPath:$sitePath /bindings:"http/*:8010:"
            & "C:\Windows\System32\inetsrv\appcmd.exe" set site /site.name:$websiteName /+bindings:"[protocol='http',bindingInformation='*:8010:']"
            Write-Host "Website created and bound to port 8010"
          } else {
            Write-Host "Website already exists"
          }
          
          # Assign app pool to the site's root application
          & "C:\Windows\System32\inetsrv\appcmd.exe" set app "$websiteName/" /applicationPool:$appPoolName
          Write-Host "Application pool assigned to website"

      - name: Stop IIS Application Pool
        shell: powershell
        run: |
          try {
            & "C:\Windows\System32\inetsrv\appcmd.exe" stop apppool /apppool.name:$env:APP_POOL_NAME -ErrorAction Stop
            Write-Host "Application pool stopped successfully"
          } catch {
            Write-Host "Application pool not found or already stopped"
          }
        continue-on-error: true

      - name: Deploy to IIS
        shell: powershell
        run: |
          $deployPath = $env:DEPLOY_PATH
          Write-Host "Deploying to $deployPath"
          if (Test-Path $deployPath) {
            Remove-Item -Path $deployPath -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "Deploy folder cleaned; ready to copy new artifacts"
          }
          New-Item -ItemType Directory -Path $deployPath -Force | Out-Null
          Copy-Item -Path "./publish/*" -Destination $deployPath -Recurse -Force
          Write-Host "Files copied successfully to $deployPath"

      - name: Set environment variable for IIS
        shell: powershell
        run: |
          & "C:\Windows\System32\inetsrv\appcmd.exe" set config -section:system.webServer/aspNetCore /+"environmentVariables.[name='ASPNETCORE_ENVIRONMENT',value='Production']" /commit:apphost 2>$null
          Write-Host "ASPNETCORE_ENVIRONMENT set to Production"
        continue-on-error: true

      - name: Verify Redis is running
        shell: powershell
        run: |
          try {
            $tcp = New-Object System.Net.Sockets.TcpClient
            $tcp.Connect("localhost", 6379)
            $tcp.Close()
            Write-Host "✅ Redis is running on localhost:6379"
          } catch {
            Write-Host "❌ Redis is NOT running on localhost:6379"
            Write-Host "Install Redis: https://github.com/tporadowski/redis/releases or use Docker: docker run -d -p 6379:6379 redis"
            throw "Redis is required for the application to function properly"
          }

      - name: Start IIS Application Pool
        shell: powershell
        run: |
          & "C:\Windows\System32\inetsrv\appcmd.exe" start apppool /apppool.name:$env:APP_POOL_NAME
          Start-Sleep -Seconds 3
          Write-Host "Application pool started"

      - name: Verify deployment
        shell: powershell
        run: |
          Start-Sleep -Seconds 5
          # $response = Invoke-WebRequest -Uri "http://localhost/VoiceFirstAdminAPI/health" -UseBasicParsing -ErrorAction SilentlyContinue
          # if ($response.StatusCode -eq 200) {
          #   Write-Host "Health check passed"
          # } else {
          #   throw "Health check failed with status code $($response.StatusCode)"
          # }
          Write-Host "Health check skipped for now"

      - name: Notify deployment status
        if: always()
        shell: powershell
        run: |
          if ("${{ job.status }}" -eq "success") {
            Write-Host "✅ Deployment successful!"
          } else {
            Write-Host "❌ Deployment failed!"
            exit 1
          }
